<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ± ì ì‹¬ íˆ¬í‘œ</title>
  <style>
    /* ===== Reset & Base ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }
    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f7fa;
      color: #1a1a2e;
      min-height: 100vh;
    }

    /* ===== Layout ===== */
    .app { max-width: 720px; margin: 0 auto; padding: 16px; }

    /* ===== Header ===== */
    .header {
      background: linear-gradient(135deg, #1976d2, #1565c0);
      color: #fff;
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .header-title { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }
    .header-date  { font-size: 0.9rem; opacity: 0.85; }
    .header-refresh { font-size: 0.78rem; opacity: 0.7; }

    /* ===== Phase Badge ===== */
    .phase-bar {
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .phase-bar.before_start { background: #e3f2fd; color: #0d47a1; }
    .phase-bar.vote_active  { background: #e8f5e9; color: #1b5e20; }
    .phase-bar.menu_active  { background: #fff3e0; color: #bf360c; }
    .phase-bar.all_locked   { background: #f3e5f5; color: #4a148c; }
    .phase-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .vote_active  .phase-dot { background: #43a047; animation: blink 1.2s ease-in-out infinite; }
    .menu_active  .phase-dot { background: #ff7043; animation: blink 1.2s ease-in-out infinite; }
    .before_start .phase-dot { background: #90caf9; }
    .all_locked   .phase-dot { background: #ce93d8; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

    /* ===== Cards ===== */
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 1rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ===== ë“í‘œ í˜„í™© ===== */
    .vote-bars { display: flex; flex-direction: column; gap: 10px; }
    .vote-bar-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .vote-bar-label {
      width: 110px;
      font-size: 0.88rem;
      font-weight: 600;
      flex-shrink: 0;
      text-align: right;
      color: #444;
    }
    .vote-bar-label.winner { color: #2e7d32; }
    .vote-bar-track {
      flex: 1;
      background: #eee;
      border-radius: 6px;
      height: 22px;
      overflow: hidden;
    }
    .vote-bar-fill {
      height: 100%;
      background: #90caf9;
      border-radius: 6px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      padding-left: 8px;
      font-size: 0.78rem;
      font-weight: 700;
      color: #1a237e;
      min-width: 0;
    }
    .vote-bar-fill.winner { background: #a5d6a7; color: #1b5e20; }
    .vote-bar-count {
      width: 30px;
      text-align: right;
      font-size: 0.88rem;
      font-weight: 700;
      color: #555;
    }

    /* ===== ì°¸ì—¬ í˜„í™© ===== */
    .progress-summary {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    .progress-track {
      flex: 1;
      height: 10px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #42a5f5;
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    .non-voters {
      font-size: 0.82rem;
      color: #e53935;
      margin-top: 6px;
      padding: 6px 10px;
      background: #ffebee;
      border-radius: 8px;
      line-height: 1.5;
    }

    /* ===== íˆ¬í‘œ í¼ ===== */
    .select-person {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #90caf9;
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      color: #1a1a2e;
      background: #fff;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%231976d2' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
      transition: border-color 0.2s;
    }
    .select-person:focus { outline: none; border-color: #1976d2; }

    .vote-form { margin-top: 16px; }
    .form-section { margin-bottom: 18px; }
    .form-label {
      font-size: 0.82rem;
      font-weight: 700;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      display: block;
    }

    /* ì‹ë‹¹ ì²´í¬ë°•ìŠ¤ ê·¸ë¦¬ë“œ */
    .restaurant-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }
    .rest-chip {
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      background: #fafafa;
    }
    .rest-chip input[type=checkbox] { display: none; }
    .rest-chip:hover { border-color: #1976d2; background: #e3f2fd; }
    .rest-chip.checked {
      border-color: #1976d2;
      background: #e3f2fd;
      color: #0d47a1;
      font-weight: 700;
    }
    .rest-chip.disabled { opacity: 0.45; cursor: not-allowed; pointer-events: none; }
    .chip-check {
      width: 18px; height: 18px;
      border: 2px solid #ccc;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
      font-size: 12px;
    }
    .rest-chip.checked .chip-check {
      background: #1976d2;
      border-color: #1976d2;
      color: #fff;
    }

    /* ì‹ì‚¬X ì²´í¬ë°•ìŠ¤ */
    .opt-out-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border: 2px solid #ccc;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      font-size: 0.9rem;
      font-weight: 600;
      background: #fafafa;
      transition: all 0.15s;
      width: fit-content;
    }
    .opt-out-btn input[type=checkbox] { display: none; }
    .opt-out-btn:hover { border-color: #ef5350; background: #ffebee; }
    .opt-out-btn.checked { border-color: #ef5350; background: #ffebee; color: #b71c1c; }
    .opt-out-btn .chip-check { border-color: #ccc; }
    .opt-out-btn.checked .chip-check { background: #ef5350; border-color: #ef5350; color: #fff; }

    /* ë©”ë‰´ ì…ë ¥ */
    .menu-inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .input-row { display: flex; gap: 8px; }
    .input-field {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .input-field:focus { outline: none; border-color: #1976d2; }
    .input-field.small { flex: 0 0 110px; }
    .input-field:disabled { background: #f5f5f5; color: #999; }

    /* ë²„íŠ¼ */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-primary:hover { background: #1565c0; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled {
      background: #bbb;
      cursor: not-allowed;
      transform: none;
    }
    .btn-menu {
      background: #ef6c00;
      color: #fff;
    }
    .btn-menu:hover { background: #e65100; }
    .btn-menu:disabled { background: #bbb; cursor: not-allowed; }
    .btn-sm {
      padding: 7px 14px;
      font-size: 0.82rem;
    }

    .action-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    /* ===== ì „ì²´ í˜„í™© í…Œì´ë¸” ===== */
    .people-table-wrap { overflow-x: auto; }
    .people-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .people-table th, .people-table td {
      padding: 8px 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    .people-table th {
      background: #f0f4f8;
      font-weight: 700;
      font-size: 0.78rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .people-table td:first-child { text-align: left; font-weight: 600; }
    .people-table tr:last-child td { border-bottom: none; }
    .people-table tr:hover td { background: #f9f9f9; }
    .check-mark { color: #43a047; font-size: 1rem; }
    .opt-out-mark { color: #ef5350; font-size: 0.8rem; font-weight: 700; }
    .voted-name { color: #1a1a2e; }
    .not-voted-name { color: #aaa; }

    /* ===== ì•Œë¦¼ í† ìŠ¤íŠ¸ ===== */
    .toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
      align-items: center;
    }
    .toast {
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      animation: slideUp 0.3s ease, fadeOut 0.4s ease 2.6s forwards;
      pointer-events: auto;
      max-width: 340px;
      text-align: center;
    }
    .toast.success { background: #2e7d32; }
    .toast.error   { background: #c62828; }
    .toast.info    { background: #1565c0; }
    @keyframes slideUp  { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeOut  { from { opacity:1; } to { opacity:0; } }

    /* ===== ë¡œë”© ===== */
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 0.95rem;
    }
    .spinner {
      display: inline-block;
      width: 24px; height: 24px;
      border: 3px solid #e0e0e0;
      border-top-color: #1976d2;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== ì„¤ì • ëª¨ë‹¬ ===== */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 8px 40px rgba(0,0,0,0.25);
    }
    .modal h2 { font-size: 1.2rem; margin-bottom: 16px; }
    .modal p  { font-size: 0.85rem; color: #555; margin-bottom: 12px; line-height: 1.6; }
    .modal input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      margin-bottom: 14px;
    }
    .modal input:focus { outline: none; border-color: #1976d2; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-secondary:hover { background: #e0e0e0; }

    /* ===== ë°˜ì‘í˜• ===== */
    @media (max-width: 480px) {
      .restaurant-grid { grid-template-columns: repeat(2, 1fr); }
      .input-row { flex-direction: column; }
      .input-field.small { flex: 1; }
      .header-title { font-size: 1.25rem; }
    }
  </style>
</head>
<body>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="setupModal">
  <div class="modal">
    <h2>âš™ï¸ Apps Script URL ì„¤ì •</h2>
    <p>
      Google Apps Script Web App ë°°í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”.<br>
      í•œ ë²ˆ ì„¤ì •í•˜ë©´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.<br><br>
      <strong>ë°°í¬ ë°©ë²•:</strong> Apps Script í¸ì§‘ê¸° â†’ ë°°í¬ â†’ ìƒˆ ë°°í¬ â†’ ì›¹ ì•±<br>
      ì‹¤í–‰ ê³„ì •: ë‚˜ / ì•¡ì„¸ìŠ¤: ëª¨ë“  ì‚¬ëŒ
    </p>
    <input type="url" id="setupUrl"
      placeholder="https://script.google.com/macros/s/.../exec"
      autocomplete="off" spellcheck="false" />
    <input type="text" id="setupKey"
      placeholder="API í‚¤ (ì„¤ì •í•œ ê²½ìš°ì—ë§Œ ì…ë ¥)" />
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveSetup()">ì €ì¥ í›„ ì‹œì‘</button>
    </div>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div class="toast-container" id="toastContainer"></div>

<!-- ì•± -->
<div class="app" id="app" style="display:none">

  <!-- í—¤ë” -->
  <div class="header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <span class="header-title">ğŸ± ì ì‹¬ íˆ¬í‘œ</span>
      <button class="btn btn-sm" style="background:rgba(255,255,255,0.2); color:#fff; border-radius:8px;"
        onclick="showSetupModal(true)">âš™ï¸</button>
    </div>
    <div class="header-date" id="headerDate">â€“</div>
    <div class="header-refresh" id="headerRefresh">ë§ˆì§€ë§‰ ê°±ì‹ : â€“</div>
  </div>

  <!-- ë‹¨ê³„ í‘œì‹œ -->
  <div class="phase-bar" id="phaseBar">
    <div class="phase-dot"></div>
    <span id="phaseLabel">ë¡œë”© ì¤‘...</span>
  </div>

  <!-- ë“í‘œ í˜„í™© -->
  <div class="card">
    <div class="card-title">ğŸ“Š ì‹¤ì‹œê°„ ë“í‘œ í˜„í™©</div>
    <div class="vote-bars" id="voteBars">
      <div class="loading"><span class="spinner"></span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>

  <!-- ì°¸ì—¬ í˜„í™© -->
  <div class="card">
    <div class="card-title">ğŸ‘¥ ì°¸ì—¬ í˜„í™©</div>
    <div class="progress-summary">
      <span id="progressText" style="font-weight:700; min-width:80px;">0 / 0</span>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      <span id="progressPct" style="font-size:0.85rem; color:#666;">0%</span>
    </div>
    <div class="non-voters" id="nonVoters" style="display:none"></div>
  </div>

  <!-- ë‚´ íˆ¬í‘œ -->
  <div class="card">
    <div class="card-title">âœ‹ ë‚´ íˆ¬í‘œ</div>

    <select class="select-person" id="personSelect" onchange="onPersonChange()">
      <option value="">-- ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš” --</option>
    </select>

    <div class="vote-form" id="voteForm" style="display:none">

      <!-- ì‹ë‹¹ ì„ íƒ -->
      <div class="form-section" id="voteSection">
        <span class="form-label">ì‹ë‹¹ ì„ íƒ (ìµœëŒ€ <span id="maxVoteLabel">3</span>ê°œ)</span>
        <div class="restaurant-grid" id="restaurantGrid"></div>
        <div style="margin-top:12px;">
          <label class="opt-out-btn" id="optOutBtn" onclick="toggleOptOut()">
            <input type="checkbox" id="optOutCheck">
            <div class="chip-check" id="optOutChipCheck">âœ—</div>
            ì‹ì‚¬X (ì˜¤ëŠ˜ ë¶ˆì°¸)
          </label>
        </div>
        <div class="action-row">
          <button class="btn btn-primary" id="saveVoteBtn" onclick="saveVote()">
            íˆ¬í‘œ ì €ì¥
          </button>
        </div>
      </div>

      <!-- ë©”ë‰´ ì…ë ¥ -->
      <div class="form-section" id="menuSection" style="margin-top:18px; padding-top:18px; border-top:1px solid #eee;">
        <span class="form-label">ë©”ë‰´ ì…ë ¥</span>
        <div class="menu-inputs">
          <input class="input-field" type="text" id="menuName"
            placeholder="ë©”ë‰´ëª… (ì˜ˆ: ê¹€ì¹˜ì°Œê°œ)" />
          <div class="input-row">
            <input class="input-field small" type="number" id="menuPrice"
              placeholder="ê°€ê²© (ì›)" min="0" step="100" />
            <input class="input-field" type="text" id="menuNote"
              placeholder="ë¹„ê³  (ì˜ˆ: í¬ì¥, ì¹´ë“œê²°ì œ ê°€ëŠ¥)" />
          </div>
        </div>
        <div class="action-row">
          <button class="btn btn-menu" id="saveMenuBtn" onclick="saveMenu()">
            ë©”ë‰´ ì €ì¥
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì „ì²´ í˜„í™© í…Œì´ë¸” -->
  <div class="card">
    <div class="card-title">ğŸ“‹ ì „ì²´ í˜„í™©</div>
    <div class="people-table-wrap">
      <table class="people-table" id="peopleTable">
        <thead>
          <tr>
            <th>ì´ë¦„</th>
            <th id="th0">â€“</th>
            <th id="th1">â€“</th>
            <th id="th2">â€“</th>
            <th id="th3">â€“</th>
            <th id="th4">â€“</th>
            <th>ì‹ì‚¬X</th>
            <th>ë©”ë‰´</th>
          </tr>
        </thead>
        <tbody id="peopleTableBody">
          <tr><td colspan="8" class="loading">ë¡œë”© ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div style="text-align:center; font-size:0.75rem; color:#bbb; margin-top:8px; margin-bottom:24px;">
    15ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  Â· <a href="#" onclick="loadState(true); return false;" style="color:#90caf9;">ì§€ê¸ˆ ê°±ì‹ </a>
  </div>
</div>

<script>
// ===== ì„¤ì • =====
const STORAGE_URL_KEY = 'meal_vote_script_url';
const STORAGE_KEY_KEY = 'meal_vote_api_key';
let SCRIPT_URL = '';
let API_KEY    = '';

let state = null;        // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°
let refreshTimer = null;

// ===== ì´ˆê¸°í™” =====
window.addEventListener('DOMContentLoaded', () => {
  SCRIPT_URL = localStorage.getItem(STORAGE_URL_KEY) || '';
  API_KEY    = localStorage.getItem(STORAGE_KEY_KEY) || '';

  if (!SCRIPT_URL) {
    document.getElementById('setupModal').classList.remove('hidden');
  } else {
    startApp();
  }
});

function saveSetup() {
  const url = document.getElementById('setupUrl').value.trim();
  const key = document.getElementById('setupKey').value.trim();
  if (!url) { showToast('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
  SCRIPT_URL = url;
  API_KEY    = key;
  localStorage.setItem(STORAGE_URL_KEY, url);
  localStorage.setItem(STORAGE_KEY_KEY, key);
  document.getElementById('setupModal').classList.add('hidden');
  startApp();
}

function showSetupModal(prefill) {
  if (prefill) {
    document.getElementById('setupUrl').value = SCRIPT_URL;
    document.getElementById('setupKey').value = API_KEY;
  }
  document.getElementById('setupModal').classList.remove('hidden');
}

function startApp() {
  document.getElementById('app').style.display = '';
  loadState(true);
  refreshTimer = setInterval(() => loadState(false), 15000);
}

// ===== API í˜¸ì¶œ =====
async function callApi(params) {
  const url = new URL(SCRIPT_URL);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  if (API_KEY) url.searchParams.set('key', API_KEY);

  const resp = await fetch(url.toString(), {
    redirect: 'follow',
    cache: 'no-cache'
  });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  return resp.json();
}

// ===== ìƒíƒœ ë¡œë“œ =====
async function loadState(showLoading) {
  if (showLoading) {
    document.getElementById('voteBars').innerHTML =
      '<div class="loading"><span class="spinner"></span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  }
  try {
    const data = await callApi({ action: 'state' });
    if (!data.ok) throw new Error(data.error || 'ì˜¤ë¥˜');
    state = data;
    renderState();
    document.getElementById('headerRefresh').textContent =
      'ë§ˆì§€ë§‰ ê°±ì‹ : ' + new Date().toLocaleTimeString('ko-KR');
  } catch (e) {
    if (showLoading) {
      document.getElementById('voteBars').innerHTML =
        `<div class="loading" style="color:#e53935;">âš ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</div>`;
    }
    console.error(e);
  }
}

// ===== ë Œë”ë§ =====
function renderState() {
  if (!state) return;
  const { date, phase, phaseLabel, restaurants, people, totalPeople, votedCount, nonVoters, config } = state;

  // í—¤ë”
  document.getElementById('headerDate').textContent = date + ' ì ì‹¬ íˆ¬í‘œ';

  // Phase ë°°ì§€
  const phaseBar = document.getElementById('phaseBar');
  phaseBar.className = 'phase-bar ' + phase;
  document.getElementById('phaseLabel').textContent = phaseLabel;

  // ë“í‘œ í˜„í™©
  const maxCount = Math.max(...restaurants.map(r => r.count), 1);
  document.getElementById('voteBars').innerHTML = restaurants.map(r => {
    const pct     = Math.round((r.count / maxCount) * 100);
    const isWin   = r.rank === 1 && r.count > 0;
    const winCls  = isWin ? ' winner' : '';
    const label   = isWin ? `ğŸ† ${r.name}` : r.name;
    return `
      <div class="vote-bar-row">
        <div class="vote-bar-label${winCls}">${label}</div>
        <div class="vote-bar-track">
          <div class="vote-bar-fill${winCls}" style="width:${pct}%">
            ${r.count > 0 ? r.count + 'í‘œ' : ''}
          </div>
        </div>
        <div class="vote-bar-count">${r.count}</div>
      </div>`;
  }).join('');

  // ì°¸ì—¬ í˜„í™©
  const pct = totalPeople > 0 ? Math.round((votedCount / totalPeople) * 100) : 0;
  document.getElementById('progressText').textContent = `${votedCount} / ${totalPeople}`;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';
  const nvEl = document.getElementById('nonVoters');
  if (nonVoters && nonVoters.length > 0 && phase !== 'all_locked') {
    nvEl.style.display = '';
    nvEl.textContent = 'â° ì•„ì§ ë¯¸íˆ¬í‘œ: ' + nonVoters.join(', ');
  } else {
    nvEl.style.display = 'none';
  }

  // ì‹ë‹¹ í—¤ë”
  (config.fixedRestaurants || []).forEach((name, i) => {
    const el = document.getElementById('th' + i);
    if (el) el.textContent = name;
  });

  // ì „ì²´ í˜„í™© í…Œì´ë¸”
  const tbody = document.getElementById('peopleTableBody');
  if (!people || people.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#aaa;padding:20px;">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  } else {
    tbody.innerHTML = people.map(p => {
      const nameCls = p.hasVoted ? 'voted-name' : 'not-voted-name';
      const restCells = (config.fixedRestaurants || []).map(r =>
        p.votes.includes(r)
          ? '<td><span class="check-mark">âœ“</span></td>'
          : '<td></td>'
      ).join('');
      const optCell = p.optOut
        ? '<td><span class="opt-out-mark">X</span></td>'
        : '<td></td>';
      const menuText = [
        p.menu.name,
        p.menu.price !== null ? p.menu.price.toLocaleString('ko-KR') + 'ì›' : '',
        p.menu.note
      ].filter(Boolean).join(' Â· ');
      return `
        <tr>
          <td class="${nameCls}">${escHtml(p.name)}</td>
          ${restCells}
          ${optCell}
          <td style="text-align:left; font-size:0.82rem; color:#555;">${escHtml(menuText)}</td>
        </tr>`;
    }).join('');
  }

  // ë‚´ íˆ¬í‘œ í¼ ê°±ì‹  (ì´ë¦„ ì„ íƒëœ ê²½ìš°)
  renderPersonSelect(config, people);
  const selected = document.getElementById('personSelect').value;
  if (selected) renderMyVoteForm(selected, phase, config, people);
}

// ===== ì´ë¦„ ë“œë¡­ë‹¤ìš´ =====
function renderPersonSelect(config, people) {
  const sel = document.getElementById('personSelect');
  const current = sel.value;
  sel.innerHTML = '<option value="">-- ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš” --</option>';
  (people || []).forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.name;
    opt.textContent = p.name + (p.hasVoted ? ' âœ“' : '');
    sel.appendChild(opt);
  });
  if (current) sel.value = current;
}

// ===== ì´ë¦„ ì„ íƒ =====
function onPersonChange() {
  if (!state) return;
  const name = document.getElementById('personSelect').value;
  const { phase, config, people } = state;
  if (!name) {
    document.getElementById('voteForm').style.display = 'none';
    return;
  }
  renderMyVoteForm(name, phase, config, people);
}

// ===== ë‚´ íˆ¬í‘œ í¼ ë Œë”ë§ =====
function renderMyVoteForm(name, phase, config, people) {
  const form = document.getElementById('voteForm');
  form.style.display = '';

  const person = (people || []).find(p => p.name === name);
  const myVotes  = person ? person.votes : [];
  const myOptOut = person ? person.optOut : false;

  const voteDisabled = (phase !== 'vote_active');
  const menuDisabled = myOptOut;

  // ìµœëŒ€ ê°œìˆ˜ ë¼ë²¨
  document.getElementById('maxVoteLabel').textContent = config.maxVotePerPerson || 3;

  // ì‹ë‹¹ ê·¸ë¦¬ë“œ
  const grid = document.getElementById('restaurantGrid');
  grid.innerHTML = (config.fixedRestaurants || []).map(r => {
    const checked = myVotes.includes(r);
    return `
      <label class="rest-chip${checked ? ' checked' : ''}${voteDisabled ? ' disabled' : ''}"
        id="chip_${encodeId(r)}" onclick="${voteDisabled ? '' : `clickRestChip('${escJs(r)}')`}">
        <input type="checkbox" ${checked ? 'checked' : ''} ${voteDisabled ? 'disabled' : ''}>
        <div class="chip-check">${checked ? 'âœ“' : ''}</div>
        <span>${escHtml(r)}</span>
      </label>`;
  }).join('');

  // ì‹ì‚¬X
  const optOutBtn = document.getElementById('optOutBtn');
  const optOutChip = document.getElementById('optOutChipCheck');
  if (myOptOut) {
    optOutBtn.classList.add('checked');
    optOutChip.textContent = 'âœ“';
  } else {
    optOutBtn.classList.remove('checked');
    optOutChip.textContent = 'âœ—';
  }
  if (voteDisabled) {
    optOutBtn.style.pointerEvents = 'none';
    optOutBtn.style.opacity = '0.45';
  } else {
    optOutBtn.style.pointerEvents = '';
    optOutBtn.style.opacity = '';
  }

  // íˆ¬í‘œ ì €ì¥ ë²„íŠ¼
  document.getElementById('saveVoteBtn').disabled = voteDisabled;

  // ë©”ë‰´ ì…ë ¥
  const mn   = document.getElementById('menuName');
  const mp   = document.getElementById('menuPrice');
  const mnot = document.getElementById('menuNote');
  const msb  = document.getElementById('saveMenuBtn');

  mn.value   = person && person.menu.name  ? person.menu.name  : '';
  mp.value   = person && person.menu.price !== null ? person.menu.price : '';
  mnot.value = person && person.menu.note  ? person.menu.note  : '';

  [mn, mp, mnot].forEach(el => { el.disabled = menuDisabled; });
  msb.disabled = menuDisabled;

  if (menuDisabled) {
    mn.placeholder = 'ì‹ì‚¬X ì„ íƒ ì‹œ ì…ë ¥ ë¶ˆê°€';
  } else {
    mn.placeholder = 'ë©”ë‰´ëª… (ì˜ˆ: ê¹€ì¹˜ì°Œê°œ)';
  }
}

// ===== ì‹ë‹¹ ì¹© í† ê¸€ =====
function clickRestChip(restaurant) {
  if (!state) return;
  const name = document.getElementById('personSelect').value;
  if (!name) return;

  const person = state.people.find(p => p.name === name);
  const isChecked = person ? person.votes.includes(restaurant) : false;

  // ìµœëŒ€ ê°œìˆ˜ ê²€ì‚¬ (ë¡œì»¬)
  if (!isChecked) {
    const currentCount = person ? person.votes.length : 0;
    const max = state.config.maxVotePerPerson || 3;
    if (currentCount >= max) {
      showToast(`ìµœëŒ€ ${max}ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'error');
      return;
    }
  }

  // ë‚™ê´€ì  ì—…ë°ì´íŠ¸ (UI ì¦‰ì‹œ ë°˜ì˜)
  if (person) {
    if (isChecked) {
      person.votes = person.votes.filter(v => v !== restaurant);
    } else {
      person.votes.push(restaurant);
      person.optOut = false;
    }
    person.hasVoted = person.votes.length > 0 || person.optOut;
  }
  renderMyVoteForm(name, state.phase, state.config, state.people);
}

// ===== ì‹ì‚¬X í† ê¸€ =====
function toggleOptOut() {
  if (!state) return;
  const name = document.getElementById('personSelect').value;
  if (!name) return;
  if (state.phase !== 'vote_active') return;

  const person = state.people.find(p => p.name === name);
  if (!person) return;

  person.optOut = !person.optOut;
  if (person.optOut) {
    person.votes = [];
    person.menu  = { name: '', price: null, note: '' };
  }
  person.hasVoted = person.votes.length > 0 || person.optOut;
  renderMyVoteForm(name, state.phase, state.config, state.people);
}

// ===== íˆ¬í‘œ ì €ì¥ =====
async function saveVote() {
  const name = document.getElementById('personSelect').value;
  if (!name || !state) return;

  const person = state.people.find(p => p.name === name);
  if (!person) return;

  const btn = document.getElementById('saveVoteBtn');
  btn.disabled = true;
  btn.textContent = 'ì €ì¥ ì¤‘...';

  try {
    const tasks = [];

    // ì‹ë‹¹ íˆ¬í‘œ - ì²´í¬ëœ ê²ƒë“¤ ëª¨ë‘ ì „ì†¡ (ê¸°ì¡´ ìƒíƒœì™€ ë¹„êµê°€ ì–´ë ¤ìš°ë¯€ë¡œ ì„œë²„ ìƒíƒœ ê¸°ì¤€)
    // ì„œë²„ì—ì„œ í˜„ì¬ ìƒíƒœë¥¼ ë‹¤ì‹œ ì½ì–´ì™€ ë¹„êµ
    const serverState = await callApi({ action: 'state' });
    const serverPerson = serverState.people.find(p => p.name === name);
    const serverVotes  = serverPerson ? serverPerson.votes : [];
    const serverOptOut = serverPerson ? serverPerson.optOut : false;

    const myVotes  = person.votes;
    const myOptOut = person.optOut;

    // ì‹ë‹¹ íˆ¬í‘œ ë³€ê²½ë¶„ ë°˜ì˜
    const allRests = state.config.fixedRestaurants || [];
    for (const r of allRests) {
      const wasChecked  = serverVotes.includes(r);
      const nowChecked  = myVotes.includes(r);
      if (wasChecked !== nowChecked) {
        tasks.push(callApi({ action: 'vote', person: name, restaurant: r, checked: nowChecked }));
      }
    }

    // ì‹ì‚¬X ë³€ê²½ë¶„
    if (serverOptOut !== myOptOut) {
      tasks.push(callApi({ action: 'opt_out', person: name, checked: myOptOut }));
    }

    const results = await Promise.all(tasks);
    const errors  = results.filter(r => !r.ok);
    if (errors.length > 0) {
      showToast('ì¼ë¶€ í•­ëª© ì €ì¥ ì‹¤íŒ¨: ' + errors[0].error, 'error');
    } else {
      showToast(tasks.length === 0 ? 'ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.' : 'íˆ¬í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }
    await loadState(false);
  } catch (e) {
    showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
    await loadState(false);
  } finally {
    btn.disabled = false;
    btn.textContent = 'íˆ¬í‘œ ì €ì¥';
  }
}

// ===== ë©”ë‰´ ì €ì¥ =====
async function saveMenu() {
  const name = document.getElementById('personSelect').value;
  if (!name) return;

  const menuName = document.getElementById('menuName').value.trim();
  const price    = document.getElementById('menuPrice').value;
  const note     = document.getElementById('menuNote').value.trim();

  const btn = document.getElementById('saveMenuBtn');
  btn.disabled = true;
  btn.textContent = 'ì €ì¥ ì¤‘...';

  try {
    const params = { action: 'menu', person: name, menuName, note };
    if (price !== '') params.price = price;

    const result = await callApi(params);
    if (result.ok) {
      showToast('ë©”ë‰´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    } else {
      showToast('ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
    }
    await loadState(false);
  } catch (e) {
    showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ë©”ë‰´ ì €ì¥';
  }
}

// ===== í† ìŠ¤íŠ¸ =====
function showToast(msg, type) {
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = `toast ${type || 'info'}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ===== ìœ í‹¸ =====
function escHtml(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escJs(str) {
  return String(str || '').replace(/'/g, "\\'");
}
function encodeId(str) {
  return encodeURIComponent(str).replace(/%/g, '_');
}
</script>
</body>
</html>
